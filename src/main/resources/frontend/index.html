<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
    <h1 class="text-center mb-4">ðŸ“š Library Management</h1>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#authors">Authors</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#categories">Categories</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#books">Books</button></li>
    </ul>

    <div class="tab-content">

        <!-- Authors -->
        <div class="tab-pane fade show active" id="authors">
            <h3>Authors</h3>
            <form id="authorForm" class="row g-2 mb-3">
                <div class="col"><input type="text" id="authorName" class="form-control" placeholder="Author Name" required></div>
                <div class="col-auto"><button type="submit" class="btn btn-primary">Add Author</button></div>
            </form>
            <ul class="list-group" id="authorList"></ul>
        </div>

        <!-- Categories -->
        <div class="tab-pane fade" id="categories">
            <h3>Categories</h3>
            <form id="categoryForm" class="row g-2 mb-3">
                <div class="col"><input type="text" id="categoryName" class="form-control" placeholder="Category Name" required></div>
                <div class="col-auto"><button type="submit" class="btn btn-success">Add Category</button></div>
            </form>
            <ul class="list-group" id="categoryList"></ul>
        </div>

        <!-- Books -->
        <div class="tab-pane fade" id="books">
            <h3>Books</h3>

            <!-- Live Search input -->
            <div class="mb-3">
                <input
                        type="text"
                        id="liveSearchInput"
                        class="form-control"
                        placeholder="Search books by title..."
                        autocomplete="off"
                />
            </div>

            <!-- Live search results -->
            <ul style="padding-bottom: 20px" class="list-group" id="liveSearchResults"></ul>

            <form id="bookForm" class="row g-2 mb-3">
                <div class="col"><input type="text" id="bookTitle" class="form-control" placeholder="Book Title" required></div>
                <div class="col">
                    <select id="bookAuthor" class="form-select" required></select>
                </div>
                <div class="col">
                    <select id="bookCategory" class="form-select" required></select>
                </div>
                <div class="col-auto"><button type="submit" class="btn btn-warning">Add Book</button></div>
            </form>

            <div class="mb-3">
                <label>Filter by Category:</label>
                <select id="filterCategory" class="form-select"></select>
            </div>
            <ul class="list-group" id="bookList"></ul>

        </div>

    </div>
</div>

<script>
    const baseUrl = "http://localhost:8080";

    // Load all data on start
    document.addEventListener("DOMContentLoaded", () => {
        loadAuthors();
        loadCategories();
        loadBooks();
    });

    // ---------------- Authors ----------------
    async function loadAuthors() {
        let res = await fetch(`${baseUrl}/authors`);
        let authors = await res.json();
        let list = document.getElementById("authorList");
        list.innerHTML = "";
        let authorSelect = document.getElementById("bookAuthor");
        authorSelect.innerHTML = "<option value=''>Select Author</option>";
        authors.forEach(a => {
            list.innerHTML += `<li class="list-group-item">${a.name}</li>`;
            authorSelect.innerHTML += `<option value="${a.id}">${a.name}</option>`;
        });
    }

    document.getElementById("authorForm").addEventListener("submit", async e => {
        e.preventDefault();
        let name = document.getElementById("authorName").value;
        await fetch(`${baseUrl}/authors`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({name})
        });
        document.getElementById("authorName").value = "";
        loadAuthors();
    });

    // ---------------- Categories ----------------
    async function loadCategories() {
        let res = await fetch(`${baseUrl}/categories`);
        let categories = await res.json();
        let list = document.getElementById("categoryList");
        list.innerHTML = "";
        let catSelect = document.getElementById("bookCategory");
        let filterSelect = document.getElementById("filterCategory");
        catSelect.innerHTML = "<option value=''>Select Category</option>";
        filterSelect.innerHTML = "<option value=''>All</option>";
        categories.forEach(c => {
            list.innerHTML += `<li class="list-group-item">${c.name}</li>`;
            catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            filterSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        });
    }

    document.getElementById("categoryForm").addEventListener("submit", async e => {
        e.preventDefault();
        let name = document.getElementById("categoryName").value;
        await fetch(`${baseUrl}/categories`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({name})
        });
        document.getElementById("categoryName").value = "";
        loadCategories();
    });

    // ---------------- Books ----------------
    async function loadBooks(categoryId = "") {
        let url = categoryId ? `${baseUrl}/books/category/${categoryId}` : `${baseUrl}/books`;
        let res = await fetch(url);
        let books = await res.json();
        let list = document.getElementById("bookList");
        list.innerHTML = "";
        books.forEach(b => {
            list.innerHTML += `<li class="list-group-item">${b.title} <span class="badge bg-info">${b.category.name}</span> <span class="badge bg-secondary">${b.author.name}</span></li>`;
        });
    }

    document.getElementById("bookForm").addEventListener("submit", async e => {
        e.preventDefault();
        let title = document.getElementById("bookTitle").value;
        let authorId = document.getElementById("bookAuthor").value;
        let categoryId = document.getElementById("bookCategory").value;
        await fetch(`${baseUrl}/books`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                title,
                author: { id: authorId },
                category: { id: categoryId }
            })
        });
        document.getElementById("bookTitle").value = "";
        loadBooks();
    });

    document.getElementById("filterCategory").addEventListener("change", e => {
        let id = e.target.value;
        loadBooks(id);
    });

<!--    Live Search-->
    const searchInput = document.getElementById("liveSearchInput");
const resultsList = document.getElementById("liveSearchResults");

let debounceTimeout = null;

searchInput.addEventListener("input", () => {
  clearTimeout(debounceTimeout);
  const query = searchInput.value.trim();

  if (query.length === 0) {
    resultsList.innerHTML = ""; // clear results if empty input
    return;
  }

  debounceTimeout = setTimeout(() => {
    fetch(`${baseUrl}/books/search?title=${encodeURIComponent(query)}`)
      .then(res => {
        if (!res.ok) throw new Error("Network error");
        return res.json();
      })
      .then(books => {
        resultsList.innerHTML = "";
        if (books.length === 0) {
          resultsList.innerHTML = `<li class="list-group-item">No results found</li>`;
        } else {
          books.forEach(book => {
            resultsList.innerHTML += `
              <li class="list-group-item">
                <strong>${book.title}</strong> by ${book.author?.name || "Unknown"}
              </li>`;
          });
        }
      })
      .catch(err => {
        resultsList.innerHTML = `<li class="list-group-item text-danger">Error: ${err.message}</li>`;
      });
  }, 300); // wait 300ms after last keystroke before fetching
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
